rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helpers ──────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function getMembership(futId) {
      return get(/databases/$(database)/documents/futs/$(futId)/members/$(request.auth.uid));
    }

    function isMember(futId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/futs/$(futId)/members/$(request.auth.uid));
    }

    function hasRole(futId, allowedRoles) {
      return isMember(futId) && getMembership(futId).data.role in allowedRoles;
    }

    function isAdmin(futId) {
      return hasRole(futId, ['admin']);
    }

    function isAdminOrUser(futId) {
      return hasRole(futId, ['admin', 'user']);
    }

    // ── Futs (top-level) ────────────────────────────────────────
    match /futs/{futId} {
      allow read: if isMember(futId);
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin(futId);

      // ── Members ─────────────────────────────────────────────
      match /members/{userId} {
        allow read: if isMember(futId);
        allow write: if isAdmin(futId);
      }

      // ── Players ─────────────────────────────────────────────
      match /players/{playerId} {
        allow read: if isMember(futId);
        allow write: if isAdminOrUser(futId);
      }

      // ── Weeks ───────────────────────────────────────────────
      match /weeks/{weekId} {
        allow read: if isMember(futId);
        allow write: if isAdminOrUser(futId);

        // Teams
        match /teams/{teamId} {
          allow read: if isMember(futId);
          allow write: if isAdminOrUser(futId);
        }

        // Matches
        match /matches/{matchId} {
          allow read: if isMember(futId);
          allow write: if isAdminOrUser(futId);
        }
      }

      // ── Month Prizes ────────────────────────────────────────
      match /monthPrizes/{prizeId} {
        allow read: if isMember(futId);
        allow write: if isAdminOrUser(futId);
      }

      // ── Logs ────────────────────────────────────────────────
      match /logs/{logId} {
        allow read: if isAdminOrUser(futId);
        allow write: if false; // Only backend (Admin SDK) writes logs
      }

      // ── Invites ─────────────────────────────────────────────
      match /invites/{inviteId} {
        allow read: if isMember(futId);
        allow create, update, delete: if isAdmin(futId);
      }
    }

    // ── Users (top-level) ──────────────────────────────────
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if false; // Only backend (Admin SDK) writes user docs
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
